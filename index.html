<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Toolkit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern Color Palette */
        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-900: #0c4a6e;
            
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            --success-500: #10b981;
            --warning-500: #f59e0b;
            --error-500: #ef4444;
            
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(8px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-600);
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--primary-600);
            background: var(--primary-50);
        }

        .nav-link.active {
            color: var(--primary-600);
            background: var(--primary-100);
        }

        /* Page Container */
        .page {
            display: none;
            min-height: calc(100vh - 80px);
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Page */
        .hero {
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--white) 100%);
            padding: 4rem 2rem;
            text-align: center;
        }

        .hero-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
        }

        .cta-button {
            background: var(--primary-600);
            color: var(--white);
            padding: 0.875rem 2rem;
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 600;
            display: inline-block;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .cta-button:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .how-it-works {
            padding: 4rem 2rem;
            background: var(--white);
        }

        .how-it-works-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .how-it-works h2 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 3rem;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .step {
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-xl);
            background: var(--gray-50);
            transition: all 0.3s ease;
        }

        .step:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .step-number {
            width: 3rem;
            height: 3rem;
            background: var(--primary-600);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            margin: 0 auto 1rem;
        }

        .step h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .step p {
            color: var(--gray-600);
        }

        /* Store Page */
        .store-header {
            background: var(--white);
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .store-header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .store-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .store-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--white);
            transition: all 0.2s ease;
        }

        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .tools-grid {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .tool-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-200);
        }

        .tool-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .tool-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .add-tool-btn {
            width: 2rem;
            height: 2rem;
            background: var(--primary-600);
            color: var(--white);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-tool-btn:hover {
            background: var(--primary-700);
            transform: scale(1.1);
        }

        .tool-description {
            color: var(--gray-600);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Workspace Page */
        .workspace {
            background: var(--white);
            min-height: calc(100vh - 80px);
        }

        .workspace-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            padding: 0;
        }

        .workspace-tabs {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
        }

        .workspace-tab {
            flex: 1;
            max-width: 280px;
            padding: 1rem 1.5rem;
            background: var(--gray-100);
            border-right: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: var(--gray-600);
            position: relative;
        }

        .workspace-tab:hover {
            background: var(--gray-200);
        }

        .workspace-tab.active {
            background: var(--white);
            color: var(--primary-600);
            border-bottom: 2px solid var(--primary-600);
        }

        .workspace-tab.empty {
            justify-content: center;
            color: var(--gray-400);
        }

        .tab-controls {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .workspace-tab:hover .tab-controls {
            opacity: 1;
        }

        .tab-control-btn {
            width: 1.5rem;
            height: 1.5rem;
            background: var(--gray-300);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .tab-control-btn:hover {
            background: var(--gray-400);
        }

        .workspace-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem;
        }

        .tool-workspace {
            display: none;
        }

        .tool-workspace.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tool-header {
            margin-bottom: 2rem;
        }

        .tool-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .tool-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        /* Tool Layouts */
        .io-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .input-section, .output-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .section-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1rem;
            display: block;
        }

        .tool-textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            resize: vertical;
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .tool-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
            background: var(--white);
        }

        .tool-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .control-input, .control-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--white);
            transition: all 0.2s ease;
        }

        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px var(--primary-100);
        }

        .control-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .control-checkbox input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            accent-color: var(--primary-600);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-600);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* CBM Calculator Specific */
        .cbm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .cbm-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .cbm-card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .table-wrap {
            overflow: auto;
            max-height: 500px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .cbm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .cbm-table th,
        .cbm-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .cbm-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cbm-table tr:hover {
            background: var(--gray-50);
        }

        .qty-input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px var(--primary-100);
        }

        .status-ok { color: var(--success-500); font-weight: 600; }
        .status-warn { color: var(--warning-500); font-weight: 600; }
        .status-err { color: var(--error-500); font-weight: 600; }

        .totals {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .total-card {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: var(--radius-md);
            padding: 1rem;
            flex: 1;
            min-width: 150px;
        }

        .total-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-700);
        }

        /* Text-to-Columns Layout */
        .ttc-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .ttc-outputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* File Upload */
        .file-upload {
            margin-bottom: 1rem;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary-600);
            color: var(--white);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .file-label:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
        }

        .file-input {
            display: none;
        }

        .ocr-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            color: var(--primary-700);
            display: none;
        }

        /* Messages */
        .messages {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .io-grid,
            .cbm-grid,
            .ttc-container {
                grid-template-columns: 1fr;
            }
            
            .workspace-content {
                padding: 2rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }
            
            .nav {
                gap: 1rem;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .workspace-content {
                padding: 1rem;
            }
            
            .tool-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .ttc-outputs {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-mono { font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; }
        .truncate { 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            max-width: 200px;
        }
        .muted-small { 
            font-size: 0.75rem; 
            color: var(--gray-500); 
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showPage('home')">Master Toolkit</a>
            <nav class="nav">
                <a href="#" class="nav-link active" onclick="showPage('home')">Home</a>
                <a href="#" class="nav-link" onclick="showPage('store')">Store</a>
                <a href="#" class="nav-link" onclick="showPage('workspace')">Workspace</a>
            </nav>
        </div>
    </header>

    <!-- Home Page -->
    <div id="home" class="page active">
        <section class="hero">
            <div class="hero-content">
                <h1>Master Toolkit</h1>
                <p>Your comprehensive suite of professional tools for data processing, formatting, and analysis. Streamline your workflow with our powerful, easy-to-use utilities.</p>
                <a href="#" class="cta-button" onclick="showPage('store')">Explore Tools</a>
            </div>
        </section>

        <section class="how-it-works">
            <div class="how-it-works-content">
                <h2>How It Works</h2>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3>Discover Tools</h3>
                        <p>Browse our comprehensive store of professional tools designed for various data processing and formatting tasks.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3>Add to Workspace</h3>
                        <p>Select the tools you need and add them to your personalized workspace for easy access and efficient workflow.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3>Process & Export</h3>
                        <p>Use the tools with intuitive interfaces, process your data, and export results in various formats for your projects.</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Store Page -->
    <div id="store" class="page">
        <div class="store-header">
            <div class="store-header-content">
                <h1 class="store-title">Tool Store</h1>
                <div class="store-controls">
                    <input type="text" id="toolSearch" class="search-input" placeholder="Search tools..." onkeyup="filterTools()">
                    <select id="categoryFilter" class="filter-select" onchange="filterTools()">
                        <option value="">All Categories</option>
                        <option value="formatting">Text Formatting</option>
                        <option value="calculation">Calculations</option>
                        <option value="conversion">Data Conversion</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="tools-grid">
            <div class="tool-card" data-tool-id="text-formatter" data-categories="formatting" data-tags="text,format,uppercase">
                <div class="tool-card-header">
                    <span class="tool-name">Text Formatter</span>
                    <button class="add-tool-btn" onclick="addToolToWorkspace('text-formatter')" title="Add to Workspace">+</button>
                </div>
                <p class="tool-description">Format and clean text data with capitalization, spacing, and OCR support for images.</p>
            </div>

            <div class="tool-card" data-tool-id="cbm-calculator" data-categories="calculation" data-tags="cbm,volume,shipping">
                <div class="tool-card-header">
                    <span class="tool-name">CBM Calculator</span>
                    <button class="add-tool-btn" onclick="addToolToWorkspace('cbm-calculator')" title="Add to Workspace">+</button>
                </div>
                <p class="tool-description">Calculate cubic meters and volumetric weight for shipping with support for multiple units and formats.</p>
            </div>

            <div class="tool-card" data-tool-id="aritzia-formatter" data-categories="formatting" data-tags="aritzia,format,po">
                <div class="tool-card-header">
                    <span class="tool-name">ARITZIA Formatter</span>
                    <button class="add-tool-btn" onclick="addToolToWorkspace('aritzia-formatter')" title="Add to Workspace">+</button>
                </div>
                <p class="tool-description">Format ARITZIA purchase order data with proper structure and organization.</p>
            </div>

            <div class="tool-card" data-tool-id="po-formatter" data-categories="formatting" data-tags="po,purchase,order">
                <div class="tool-card-header">
                    <span class="tool-name">PO Formatter</span>
                    <button class="add-tool-btn" onclick="addToolToWorkspace('po-formatter')" title="Add to Workspace">+</button>
                </div>
                <p class="tool-description">Process and format purchase order numbers with expansion and duplicate removal.</p>
            </div>

            <div class="tool-card" data-tool-id="text-to-columns" data-categories="conversion" data-tags="text,columns,split">
                <div class="tool-card-header">
                    <span class="tool-name">Text-to-Columns</span>
                    <button class="add-tool-btn" onclick="addToolToWorkspace('text-to-columns')" title="Add to Workspace">+</button>
                </div>
                <p class="tool-description">Split text data into columns for easy Excel import with PO and destination code separation.</p>
            </div>
        </div>
    </div>

    <!-- Workspace Page -->
    <div id="workspace" class="page">
        <div class="workspace">
            <div class="workspace-header">
                <div class="workspace-tabs">
                    <div class="workspace-tab active" data-slot="0" onclick="switchWorkspaceTab(0)">
                        <span>Empty Slot</span>
                        <div class="tab-controls">
                            <button class="tab-control-btn" onclick="removeToolFromSlot(0)" title="Remove">×</button>
                        </div>
                    </div>
                    <div class="workspace-tab empty" data-slot="1" onclick="switchWorkspaceTab(1)">
                        <span>+ Add Tool</span>
                    </div>
                    <div class="workspace-tab empty" data-slot="2" onclick="switchWorkspaceTab(2)">
                        <span>+ Add Tool</span>
                    </div>
                    <div class="workspace-tab empty" data-slot="3" onclick="switchWorkspaceTab(3)">
                        <span>+ Add Tool</span>
                    </div>
                    <div class="workspace-tab empty" data-slot="4" onclick="switchWorkspaceTab(4)">
                        <span>+ Add Tool</span>
                    </div>
                </div>
            </div>

            <div class="workspace-content">
                <!-- Text Formatter Workspace -->
                <div id="text-formatter-workspace" class="tool-workspace">
                    <div class="tool-header">
                        <h2 class="tool-title">Text Formatter</h2>
                        <p class="tool-subtitle">Format and clean text data with capitalization and OCR support</p>
                    </div>

                    <div class="tool-controls">
                        <div class="file-upload">
                            <label for="imageInput" class="file-label">Upload Image</label>
                            <input type="file" id="imageInput" class="file-input" accept="image/*">
                        </div>
                        <div class="control-checkbox">
                            <input type="checkbox" id="capitalizeToggle" checked>
                            <label for="capitalizeToggle" class="control-label">Capitalize text</label>
                        </div>
                    </div>

                    <div id="ocr-status" class="ocr-status"></div>

                    <div class="io-grid">
                        <div class="input-section">
                            <label class="section-label">Input</label>
                            <textarea id="inputBox" class="tool-textarea" placeholder="Paste text or upload an image here..."></textarea>
                        </div>
                        <div class="output-section">
                            <label class="section-label">Output</label>
                            <textarea id="outputBox" class="tool-textarea" placeholder="Formatted output will appear here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- CBM Calculator Workspace -->
                <div id="cbm-calculator-workspace" class="tool-workspace">
                    <div class="tool-header">
                        <h2 class="tool-title">CBM Calculator</h2>
                        <p class="tool-subtitle">Calculate cubic meters and volumetric weight with editable quantities</p>
                    </div>

                    <div class="cbm-grid">
                        <div class="cbm-card">
                            <h2>Input Dimensions</h2>
                            <label class="section-label">Enter dimensions per line (supports cm, m, mm, in, ft)</label>
                            <textarea id="cbmInput" class="tool-textarea" placeholder="e.g. 50cm * 40cm * 30cm&#10;2 x 50cm x 40cm x 30cm&#10;50 x 40 x 30 cm + 2m * 3m * 4m"></textarea>

                            <div class="tool-controls" style="margin-top: 1rem; margin-bottom: 0;">
                                <div class="control-group">
                                    <label class="control-label">Default Unit</label>
                                    <select id="defaultUnit" class="control-select">
                                        <option value="cm">cm (default)</option>
                                        <option value="m">m</option>
                                        <option value="mm">mm</option>
                                        <option value="in">in</option>
                                        <option value="ft">ft</option>
                                    </select>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">CBM Decimals</label>
                                    <input id="decimals" type="number" min="0" max="6" step="1" value="3" class="control-input" style="width: 80px">
                                </div>

                                <div class="control-group">
                                    <label class="control-label">Volumetric Divisor</label>
                                    <input id="divisor" type="number" min="100" step="1" value="6000" class="control-input" style="width: 110px">
                                </div>

                                <div class="control-checkbox">
                                    <input id="volToggle" type="checkbox" checked>
                                    <label class="control-label">Enable volumetric weight</label>
                                </div>

                                <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                                    <button id="copyCsv" class="btn btn-primary btn-small">Copy CSV</button>
                                    <button id="clearInput" class="btn btn-secondary btn-small">Clear</button>
                                </div>
                            </div>

                            <div class="muted-small" style="margin-top: 1rem;">
                                Live parsing. Use <kbd style="padding: 2px 6px; background: var(--gray-100); border-radius: 4px; font-size: 0.75rem;">Ctrl+Enter</kbd> to parse immediately.
                            </div>
                        </div>

                        <div class="cbm-card">
                            <h2>Results</h2>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div class="muted-small">Rows parsed: <strong id="rowCount">0</strong></div>
                                <div class="muted-small">Divisor: <strong id="divDisplay">6000</strong></div>
                            </div>

                            <div class="table-wrap">
                                <table id="resultTable" class="cbm-table">
                                    <thead>
                                        <tr>
                                            <th>Raw</th>
                                            <th>Qty</th>
                                            <th>L (orig)</th>
                                            <th>W (orig)</th>
                                            <th>H (orig)</th>
                                            <th>L/W/H (m)</th>
                                            <th class="text-right">CBM (m³)</th>
                                            <th class="text-right">Vol (kg)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultBody"></tbody>
                                </table>
                            </div>

                            <div class="totals">
                                <div class="total-card">
                                    <div class="total-label">Total CBM</div>
                                    <div id="totalCbm" class="total-value">0.000 m³</div>
                                </div>
                                <div class="total-card" id="volTotalCard">
                                    <div class="total-label">Total Volumetric Weight</div>
                                    <div id="totalVol" class="total-value">0.00 kg</div>
                                </div>
                            </div>

                            <div id="messages" class="messages" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- ARITZIA Formatter Workspace -->
                <div id="aritzia-formatter-workspace" class="tool-workspace">
                    <div class="tool-header">
                        <h2 class="tool-title">ARITZIA Formatter</h2>
                        <p class="tool-subtitle">Format tab-separated ARITZIA data: PO [tab] ARTICLE [tab] STYLE [tab] DESCRIPTION</p>
                    </div>

                    <div class="io-grid">
                        <div class="input-section">
                            <label class="section-label">Input (Tab-separated data)</label>
                            <textarea id="aritziaInput" class="tool-textarea" placeholder="Paste ARITZIA data here..."></textarea>
                        </div>
                        <div class="output-section">
                            <label class="section-label">Formatted Output</label>
                            <textarea id="aritziaOutput" class="tool-textarea" placeholder="Formatted output will appear here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- PO Formatter Workspace -->
                <div id="po-formatter-workspace" class="tool-workspace">
                    <div class="tool-header">
                        <h2 class="tool-title">PO Formatter</h2>
                        <p class="tool-subtitle">Process PO numbers with slash expansion and duplicate removal</p>
                    </div>

                    <div class="io-grid">
                        <div class="input-section">
                            <label class="section-label">Input PO Numbers</label>
                            <textarea id="poInput" class="tool-textarea" placeholder="Paste POs here... Examples:&#10;536838863/962/292&#10;3810083392,3810083406,3810083392&#10;810083407/392/393/400/401/406"></textarea>
                        </div>
                        <div class="output-section">
                            <label class="section-label">Formatted Output</label>
                            <textarea id="poOutput" class="tool-textarea" placeholder="Formatted output will appear here..." readonly></textarea>
                        </div>
                    </div>

                    <div class="tool-controls">
                        <button class="btn btn-primary" id="runSamplesBtn">Run Test Samples</button>
                        <button class="btn btn-primary" id="copyPOs">Copy PO Numbers</button>
                    </div>

                    <div id="poDebug" class="messages font-mono" style="white-space: pre-wrap;"></div>
                </div>

                <!-- Text-to-Columns Workspace -->
                <div id="text-to-columns-workspace" class="tool-workspace">
                    <div class="tool-header">
                        <h2 class="tool-title">Text-to-Columns</h2>
                        <p class="tool-subtitle">Split text into PO and destination columns for Excel import</p>
                    </div>

                    <div class="ttc-container">
                        <div class="input-section">
                            <label class="section-label">Input (Multiple lines)</label>
                            <textarea id="ttcInput" class="tool-textarea" placeholder="Example:&#10;536372836 KHSCH&#10;536372363/KHSCH&#10;536372383\KHSC"></textarea>

                            <div class="tool-controls" style="margin-top: 1rem; margin-bottom: 0;">
                                <button class="btn btn-primary" id="processTTCBtn">Process</button>
                                <button class="btn btn-secondary" id="clearTTCInput">Clear</button>
                                <div style="flex: 1;"></div>
                                <div class="muted-small" id="ttcSummary">0 lines processed</div>
                            </div>

                            <div id="ttcInvalid" class="messages" style="display: none; margin-top: 1rem; background: var(--error-50); border-color: var(--error-200); color: var(--error-700);"></div>
                        </div>

                        <div>
                            <div class="tool-controls" style="justify-content: space-between; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-primary btn-small" id="copyPOs">Copy PO</button>
                                    <button class="btn btn-primary btn-small" id="copyCSV">Copy as CSV</button>
                                </div>
                                <div class="muted-small">Copy & paste directly into Excel</div>
                            </div>

                            <div class="ttc-outputs">
                                <div class="output-section">
                                    <label class="section-label">PO Numbers</label>
                                    <textarea id="ttcPOs" class="tool-textarea" readonly placeholder="POs will appear here..."></textarea>
                                </div>
                                <div class="output-section">
                                    <label class="section-label">Destinations</label>
                                    <textarea id="ttcDests" class="tool-textarea" readonly placeholder="Destinations will appear here..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty Workspace -->
                <div id="empty-workspace" class="tool-workspace active">
                    <div class="tool-header">
                        <h2 class="tool-title">Welcome to Your Workspace</h2>
                        <p class="tool-subtitle">Add tools from the store to get started</p>
                    </div>
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;">⚡</div>
                        <p style="color: var(--gray-500); margin-bottom: 2rem;">Your workspace is empty. Visit the store to add tools and start working.</p>
                        <a href="#" class="btn btn-primary" onclick="showPage('store')">Browse Tools</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tesseract.js for OCR functionality -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

    <script>
        // --- Core Formatting Logic (reused by other functions) ---
        function formatText(text) {
            if (!text || typeof text !== "string") return "";

            const capitalize = document.getElementById("capitalizeToggle")?.checked;

            let result = text
                .split("\n")                             // Split into lines
                .map(line => line.trim())                // Trim spaces
                .filter(line => line.length > 0)         // Remove blanks
                .join("\n")                              // Rejoin
                .replace(/\t+/g, " ")                    // Replace tabs with space
                .replace(/ {2,}/g, " ");                 // Collapse spaces

            if (capitalize) {
                result = result.toUpperCase();           // Capitalize only if checked
            }

            return result;
        }

        // --- Tab Switching Logic ---
        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            const el = document.getElementById(tabId);
            if (el) el.classList.add('active');

            try {
                // if invoked by an onclick event, mark that tab active visually
                event.currentTarget.classList.add('active');
            } catch (e) {
                // ignore if event not present
            }
        }

        // --- Text Formatter Logic ---
        const inputBox = document.getElementById("inputBox");
        const outputBox = document.getElementById("outputBox");
        const imageInput = document.getElementById("imageInput");
        const ocrStatus = document.getElementById("ocr-status");

        if (inputBox && outputBox) {
            inputBox.addEventListener("input", () => {
                outputBox.value = formatText(inputBox.value);
            });
            
            outputBox.addEventListener("input", () => {
                // Allows manual editing of the output without affecting the input
            });
        }

        const processImageFile = (file) => {
            if (!file) return;
            if (ocrStatus) {
                ocrStatus.style.display = 'block';
                ocrStatus.textContent = 'Processing image... This may take a moment.';
            }

            Tesseract.recognize(file, 'eng', {
                logger: m => console.log(m) // Logs progress to the console
            }).then(({ data: { text } }) => {
                if (inputBox) {
                    inputBox.value = text;
                    outputBox.value = formatText(text); // Trigger formatting for Text Formatter
                }

                // If the PO tab is active and element exists, populate it (PO Formatter integration)
                const poInputEl = document.getElementById('poInput');
                const activePoTab = document.getElementById('po-formatter-workspace');
                if (poInputEl && activePoTab && activePoTab.classList.contains('active')) {
                    poInputEl.value = text;
                    processPOAndRender();
                }

                // Also if Text-to-Columns tab active, populate its input and process
                const ttcEl = document.getElementById('text-to-columns-workspace');
                const ttcInput = document.getElementById('ttcInput');
                if (ttcInput && ttcEl && ttcEl.classList.contains('active')) {
                    ttcInput.value = text;
                    processTextToColumns();
                }

                if (ocrStatus) {
                    ocrStatus.textContent = 'Image processing complete!';
                    setTimeout(() => { ocrStatus.style.display = 'none'; }, 2500);
                }
            }).catch(err => {
                console.error(err);
                if (ocrStatus) {
                    ocrStatus.textContent = 'Error processing image.';
                }
            });
        };

        if (imageInput) {
            imageInput.addEventListener("change", (e) => {
                processImageFile(e.target.files[0]);
            });
        }

        const capitalizeToggle = document.getElementById("capitalizeToggle");
        if (capitalizeToggle && outputBox && inputBox) {
            capitalizeToggle.addEventListener("change", () => {
                outputBox.value = formatText(inputBox.value);
            });
        }

        if (inputBox) {
            inputBox.addEventListener("paste", (e) => {
                const clipboard = e.clipboardData || window.clipboardData;
                const text = clipboard.getData("text/plain");

                if (text && text.trim().length > 0) {
                    // If text exists, just let it paste normally
                    setTimeout(() => {
                        outputBox.value = formatText(inputBox.value);
                    }, 10);
                } else {
                    // Otherwise, check for images
                    const items = clipboard.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            e.preventDefault(); // Prevent default so it won't paste an image blob
                            const file = items[i].getAsFile();
                            processImageFile(file);
                            break;
                        }
                    }
                }
            });
        }

        // --- CBM Calculator Logic ---
        /* =========================
            CBM Calculator - JS
            - Plain JS, modular parser
            - Designed for embedding & extension
            ========================= */

            /* -------------
            Configuration (change here if needed)
            ------------- */
            const CONFIG = {
            defaultUnit: 'cm',   // default unit when missing (can be changed in UI)
            defaultDivisor: 6000,
            decimals: 3,         // CBM rounding decimals
            volEnabled: true,
            debounceMs: 300,
            chunkThreshold: 800, // when > this many lines do chunked processing
            };

            /* -------------
            Unit conversion factors -> meters
            ------------- */
            const UNIT_FACTORS = {
            mm: 0.001,
            millimeter: 0.001, millimetre: 0.001, millimeters:0.001, millimetres:0.001,
            cm: 0.01,
            centimeter: 0.01, centimetre:0.01, centimeters:0.01, centimetres:0.01,
            m: 1,
            meter:1, metre:1, meters:1, metres:1,
            in: 0.0254, inch:0.0254, inches:0.0254,
            ft: 0.3048, foot:0.3048, feet:0.3048,
            };

            /* -------------
            Utilities
            ------------- */
            function roundTo(num, decimals){
            const p = Math.pow(10, decimals);
            return Math.round((Number(num) + Number.EPSILON) * p) / p;
            }

            function formatNum(num, decimals){
            if (num === null || num === undefined || Number.isNaN(num)) return '-';
            return roundTo(num, decimals).toFixed(decimals);
            }

            function safeText(s, max=60){
            if (typeof s !== 'string') s = String(s);
            return s.length > max ? s.slice(0, max-1) + '…' : s;
            }

            /* Debounce */
            function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }

            /* CSV escaping */
            function csvEscape(cell){
            if (cell === null || cell === undefined) return '';
            const s = String(cell);
            if (s.includes('"') || s.includes(',') || s.includes('\n')) {
                return '"' + s.replace(/"/g,'""') + '"';
            }
            return s;
            }

            /* -------------
            Parsing functions
            ------------- */

            /**
             * parseInput(text) -> returns array of parsed lines with components
             * Each returned object:
             * {
             *   rawLine: original raw text,
             *   components: [ { qty, rawComponentText, dims: {l,w,h, unitL, unitW, unitH}, l_m,w_m,h_m, cbm, vol_kg, status } ... ],
             *   aggregated: { qty, cbm, vol_kg, status }
             * }
             */
            function parseInput(text, options = {}) {
            const cfg = Object.assign({}, CONFIG, options);
            const lines = text ? text.split(/\r?\n/) : [];
            const out = [];
            for (let i=0;i<lines.length;i++){
                const raw = lines[i].trim();
                if (raw === '') continue;
                out.push(parseLine(raw, cfg));
            }
            return out;
            }

            /**
             * parseLine handles quantity, '+' summation, codes like "3810082864/KHSC",
             * parentheses, mixed separators, unit inference, and graceful errors.
             */
            function parseLine(raw, cfg){
            const original = raw;
            const status = { ok:true, messages:[] };
            // Quick detect: code-like lines containing slash/backslash and non-dimension tokens
            // If the entire line looks like "12345/KHSC" or "3810082864\KHSC" attempt to split and label as code
            const codeMatch = raw.match(/^([^+\s\\\/]+)[\\\/]([^+\s\\\/]+)$/);
            if (codeMatch) {
                const a = codeMatch[1], b = codeMatch[2];
                const found = {};
                if (/^\d+$/.test(a)) found.po = a;
                if (!/^\d+$/.test(b) && b.length>0) found.code = b;
                // mark as code-style
                return {
                rawLine: original,
                components: [],
                aggregated: { qty:1, cbm:0, vol_kg:0, status: 'Code parsed', meta: found }
                };
            }

            // Normalize separators: replace Unicode multiply sign with x, convert commas to dots in numbers? don't change commas globally
            let normalized = raw.replace(/\u00D7/g,'x').replace(/\*/g,' x ').replace(/[^\S\r\n]+/g,' ').trim();

            // Remove outer parentheses
            normalized = normalized.replace(/^\((.*)\)$/,'$1').trim();

            // split by '+' not inside parentheses (simple approach: we don't support nested parentheses heavy)
            const componentsText = splitTopLevelPlus(normalized);

            // extract line-level quantity (applies to entire line if present)
            let qtyLine = 1;
            let qtyConsumed = false;
            let leftoverFirst = componentsText[0];
            const qtyRes = extractQuantity(leftoverFirst);
            if (qtyRes) {
                qtyLine = qtyRes.qty;
                // remove qty token from the first component text
                componentsText[0] = leftoverFirst.slice(qtyRes.consumedLength).trim();
                qtyConsumed = true;
            }

            const parsedComponents = componentsText.map(compText => {
                const c = parseComponent(compText, cfg);
                // apply line-level qty (multiply) — but keep component's own qty if it had internal quantity
                c.qty = (c.qty||1) * qtyLine;
                // status propagation
                return c;
            });

            // aggregated CBM and vol
            let aggCbm = 0, aggVol = 0;
            let aggStatus = 'OK';
            for (const c of parsedComponents){
                if (c.cbm) aggCbm += c.cbm;
                if (c.vol_kg) aggVol += c.vol_kg || 0;
                if (!c.ok) {
                aggStatus = c.status || 'Warning';
                }
            }

            return {
                rawLine: original,
                components: parsedComponents,
                aggregated: {
                qty: qtyLine,
                cbm: aggCbm,
                vol_kg: aggVol,
                status: aggStatus
                }
            };
            }

            /* Split by top-level '+' (ignoring inside parentheses) */
            function splitTopLevelPlus(s){
            const parts = [];
            let cur = '', depth = 0;
            for (let i=0;i<s.length;i++){
                const ch = s[i];
                if (ch === '(') { depth++; cur += ch; continue; }
                if (ch === ')') { if (depth>0) depth--; cur += ch; continue; }
                if (ch === '+' && depth === 0) {
                parts.push(cur.trim());
                cur = '';
                continue;
                }
                cur += ch;
            }
            if (cur.trim() !== '') parts.push(cur.trim());
            return parts;
            }

            /* Extract quantity at start of a component. Returns {qty, consumedLength} or null */
            function extractQuantity(s){
            // Patterns: ^(\d+(\.\d+)?)\s*(?:pcs?|pieces|p|pc|qty:?|x|\*)\b
            // or compact like '2x50cm' or '2pcs*50cm'
            const patterns = [
                /^\s*(\d+(?:\.\d+)?)\s*(?:pcs?|pieces|p|pc)\b/i,
                /^\s*(?:qty[:\s])\s*(\d+(?:\.\d+)?)/i,
                /^\s*(\d+(?:\.\d+)?)\s*[x×\*]\s*/i,
                /^\s*(\d+(?:\.\d+)?)(?=[A-Za-z])/i // e.g., '3pcs50cm' handled above; this captures digits directly followed by letters
            ];
            for (const re of patterns){
                const m = s.match(re);
                if (m) {
                return { qty: Number(m[1]), consumedLength: m[0].length };
                }
            }
            return null;
            }

            /* parseComponent: parse a single "component" string (one cuboid)
            returns object { qty, raw, dims: {lRaw, wRaw, hRaw}, l_m,w_m,h_m, cbm, vol_kg, ok, status }
            */
            function parseComponent(compText, cfg){
            const out = {
                rawComponentText: compText,
                qty: 1,
                dims: null,
                l_m: null, w_m: null, h_m: null,
                cbm: 0,
                vol_kg: 0,
                ok: true,
                status: 'OK'
            };

            let s = compText.trim();
            if (!s) {
                out.ok = false; out.status = 'Empty component';
                return out;
            }

            // Try to extract quantity inside the component like '2pcs * 50cm * 40cm * 30cm'
            const qtyRes = extractQuantity(s);
            if (qtyRes) {
                out.qty = Number(qtyRes.qty);
                s = s.slice(qtyRes.consumedLength).trim();
            }

            // Remove parentheses around dims if any
            s = s.replace(/^\((.*)\)$/, '$1').trim();

            // Replace separators (x,×,*,comma) with space while keeping unit letters
            // But preserve patterns like "50cm40cm30cm" by not removing letters/digits adjacency.
            // We'll extract numeric tokens + unit using regex below.
            const tokens = []; // will hold {num, unit, raw}
            // Regex to find number with optional unit (e.g., 50cm, 2.5 m, 20in)
            // We'll collect all number occurrences and units if present.
            const tokenRegex = /(\d+(?:\.\d+)?)(?:\s*(mm|millimetres|millimeters|cm|centimeters|centimetres|m|meters|metres|in|inch|inches|ft|foot|feet|'|″|")?)/ig;
            let m;
            while ((m = tokenRegex.exec(s)) !== null) {
                let unit = (m[2] || '').toLowerCase();
                if (unit === "'" || unit === "'") unit = 'ft';
                if (unit === '""' || unit === '″' || unit === '"') unit = 'in';
                // normalize plural forms
                if (unit.endsWith('s')) unit = unit.replace(/s$/,'');
                tokens.push({ num: Number(m[1]), unit: unit || null, raw: m[0], idx: m.index });
            }

            // Special case: if we didn't find numbers but the string is like "50x40x30cm" or "50cm40cm30cm",
            // the regex above should find numbers. If tokens length 0 and string contains chars, mark invalid.
            if (tokens.length === 0) {
                // But attempt to salvage: detect patterns like "50x40x30 cm" by splitting on non-digit/letter
                const sepGuess = s.match(/(\d+)/g);
                if (sepGuess && sepGuess.length >= 3) {
                // assume unit at end or default
                const lastUnit = (s.match(/(mm|cm|m|in|ft|inch|inches|feet|foot)/i) || [null])[0];
                const inferredUnit = lastUnit ? lastUnit.toLowerCase() : null;
                const nums = sepGuess.map(n => Number(n));
                for (let i=0;i<nums.length;i++){
                    const unit = inferredUnit ? inferredUnit : null;
                    tokens.push({ num: nums[i], unit: unit, raw: String(nums[i]) });
                }
                } else {
                // If string contains slash/backslash like PO/code, attempt to split and label
                if (s.includes('/') || s.includes('\\')) {
                    const parts = s.split(/[\/\\]/).map(p=>p.trim()).filter(Boolean);
                    const meta = {};
                    if (parts.length>=1 && /^\d+$/.test(parts[0])) meta.po = parts[0];
                    if (parts.length>=2) meta.code = parts[1];
                    out.ok = false;
                    out.status = 'Non-dimension code(s)';
                    out.meta = meta;
                    return out;
                }
                out.ok = false; out.status = 'No dimensions detected';
                return out;
                }
            }

            // From tokens, infer units: if some tokens have units and others not, apply the last present unit to those missing
            // E.g., "50 x 40 x 30 cm" -> tokens [50,null],[40,null],[30,'cm'] -> apply 'cm' to first two
            // Find last unit in tokens
            let lastUnit = null;
            for (let t of tokens) if (t.unit) lastUnit = t.unit;
            // If still no lastUnit, check for any unit words in the full string
            if (!lastUnit) {
                const foundUnit = s.match(/(mm|cm|m|in|ft|inch|inches|feet|foot)/i);
                if (foundUnit) lastUnit = foundUnit[0].toLowerCase();
            }

            // If unitless tokens and no lastUnit found, we'll use default unit but warn
            const usingDefaultUnit = (!lastUnit);
            if (usingDefaultUnit) {
                lastUnit = cfg.defaultUnit || CONFIG.defaultUnit || 'cm';
            }

            // Assign units to tokens that are missing
            tokens.forEach(t => {
                if (!t.unit) t.unit = lastUnit;
                // normalize short forms
                if (t.unit === 'inches' || t.unit === 'inch') t.unit = 'in';
                if (t.unit === 'feet' || t.unit === 'foot') t.unit = 'ft';
            });

            // Now decide which numbers correspond to L W H.
            // If tokens length >= 3, take first three as L W H. If exactly 2, ambiguous -> invalid.
            if (tokens.length < 3) {
                out.ok = false; out.status = 'Not enough numeric dimensions (need 3)';
                return out;
            }

            // Use first three tokens as L,W,H.
            const L = tokens[0], W = tokens[1], H = tokens[2];
            out.dims = { lRaw: L.raw, wRaw: W.raw, hRaw: H.raw, unitL: L.unit, unitW: W.unit, unitH: H.unit };

            // Convert to meters (use UNIT_FACTORS)
            function toMeters(num, unit){
                const u = (unit||cfg.defaultUnit||'cm').toLowerCase();
                const mapped = UNIT_FACTORS[u];
                if (!mapped) return NaN;
                return Number(num) * mapped;
            }
            out.l_m = toMeters(L.num, L.unit);
            out.w_m = toMeters(W.num, W.unit);
            out.h_m = toMeters(H.num, H.unit);

            if (![out.l_m,out.w_m,out.h_m].every(v => Number.isFinite(v) && v > 0)) {
                out.ok = false;
                out.status = 'Invalid numeric dimension(s)';
                return out;
            }

            // CBM calculation
            out.cbm = out.l_m * out.w_m * out.h_m * (out.qty || 1);

            // Volumetric weight if enabled
            if (cfg.volEnabled) {
                const divisor = Number(cfg.defaultDivisor || CONFIG.defaultDivisor || 6000);
                // volumetric weight formula: (L_cm * W_cm * H_cm) / divisor
                const l_cm = out.l_m * 100;
                const w_cm = out.w_m * 100;
                const h_cm = out.h_m * 100;
                out.vol_kg = (l_cm * w_cm * h_cm) / divisor * (out.qty || 1);
            } else {
                out.vol_kg = 0;
            }

            // Warnings
            if (usingDefaultUnit) {
                out.ok = false;
                out.status = `No unit detected — assumed ${lastUnit}.`;
            }

            return out;
            }

            /* -------------
            UI & Rendering
            ------------- */

            const els = {
            cbmInput: document.getElementById('cbmInput'),
            defaultUnit: document.getElementById('defaultUnit'),
            divisor: document.getElementById('divisor'),
            volToggle: document.getElementById('volToggle'),
            decimals: document.getElementById('decimals'),
            resultBody: document.getElementById('resultBody'),
            totalCbm: document.getElementById('totalCbm'),
            totalVol: document.getElementById('totalVol'),
            rowCount: document.getElementById('rowCount'),
            divDisplay: document.getElementById('divDisplay'),
            messages: document.getElementById('messages'),
            copyCsv: document.getElementById('copyCsv'),
            clearInput: document.getElementById('clearInput'),
            volTotalCard: document.getElementById('volTotalCard'),
            };

            let lastParseResult = [];
            let lastCsv = '';

            /* Read UI state into options object */
            function readOptions(){
            return {
                defaultUnit: els.defaultUnit?.value || CONFIG.defaultUnit,
                defaultDivisor: Number(els.divisor?.value || CONFIG.defaultDivisor),
                decimals: Number(els.decimals?.value || CONFIG.decimals),
                volEnabled: els.volToggle?.checked,
                debounceMs: CONFIG.debounceMs,
            };
            }

            /* Render parse results with editable quantities */
            function renderResults(parsed, options){
            if (!els.resultBody) return;
            
            els.resultBody.innerHTML = '';
            let rows = 0;
            let totalCbm = 0, totalVol = 0;
            const decimals = Number(options.decimals);

            // Build CSV lines
            const csvRows = [];
            csvRows.push(['raw','qty','l_m','w_m','h_m','cbm_m3','vol_kg','status'].map(csvEscape).join(','));

            for (const lineObj of parsed){
                const rawShort = safeText(lineObj.rawLine, 40);
                if (lineObj.components.length === 0) {
                // code style or aggregated-only
                const agg = lineObj.aggregated || {cbm:0, vol_kg:0, status:''};
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="truncate">${escapeHtml(rawShort)}</td>
                                <td>1</td>
                                <td>-</td><td>-</td><td>-</td>
                                <td>-</td>
                                <td class="text-right">${formatNum(agg.cbm||0,decimals)}</td>
                                <td class="text-right">${formatNum(agg.vol_kg||0,2)}</td>
                                <td><span class="status-warn">${escapeHtml(agg.status||'Info')}</span></td>`;
                els.resultBody.appendChild(tr);
                rows++;
                totalCbm += Number(agg.cbm||0);
                totalVol += Number(agg.vol_kg||0);
                csvRows.push([lineObj.rawLine, 1, '', '', '', agg.cbm||0, agg.vol_kg||0, agg.status||''].map(csvEscape).join(','));
                continue;
                }

                // For each component produce a row with editable quantity
                lineObj.components.forEach((comp, idx) => {
                const lOrig = comp.dims ? (comp.dims.lRaw || '-') : '-';
                const wOrig = comp.dims ? (comp.dims.wRaw || '-') : '-';
                const hOrig = comp.dims ? (comp.dims.hRaw || '-') : '-';
                const lwhMeters = comp.l_m && comp.w_m && comp.h_m ? `${formatNum(comp.l_m,3)} / ${formatNum(comp.w_m,3)} / ${formatNum(comp.h_m,3)}` : '-';
                const statusClass = comp.ok ? 'status-ok' : (comp.meta || comp.status || '').toLowerCase().includes('invalid') ? 'status-err' : 'status-warn';
                const statusText = comp.status || (comp.ok ? 'OK' : 'Warning');

                const tr = document.createElement('tr');
                if (!comp.ok) tr.classList.add('invalid');
                
                // Create editable quantity input
                const qtyInput = `<input type="number" class="qty-input" value="1" min="1" step="1" data-line="${parsed.indexOf(lineObj)}" data-comp="${idx}" onchange="updateQuantity(this)">`;
                
                tr.innerHTML = `<td class="truncate" title="${escapeHtml(lineObj.rawLine)}">${escapeHtml(rawShort)}</td>
                                <td>${qtyInput}</td>
                                <td>${escapeHtml(lOrig)}</td>
                                <td>${escapeHtml(wOrig)}</td>
                                <td>${escapeHtml(hOrig)}</td>
                                <td>${escapeHtml(lwhMeters)}</td>
                                <td class="text-right cbm-cell">${formatNum(comp.cbm||0,decimals)}</td>
                                <td class="text-right vol-cell">${formatNum(comp.vol_kg||0,2)}</td>
                                <td><span class="${statusClass}">${escapeHtml(statusText)}</span>${idx>0?` <span class="muted-small">(part ${idx+1})</span>`:''}</td>`;
                els.resultBody.appendChild(tr);
                rows++;
                totalCbm += Number(comp.cbm || 0);
                totalVol += Number(comp.vol_kg || 0);

                csvRows.push([lineObj.rawLine, 1, comp.l_m||'', comp.w_m||'', comp.h_m||'', comp.cbm||0, comp.vol_kg||0, comp.status||''].map(csvEscape).join(','));
                });
            }

            lastCsv = csvRows.join('\n');

            if (els.rowCount) els.rowCount.textContent = rows;
            if (els.totalCbm) els.totalCbm.textContent = `${formatNum(totalCbm, options.decimals)} m³`;
            if (els.totalVol) els.totalVol.textContent = `${formatNum(totalVol,2)} kg`;
            if (els.divDisplay) els.divDisplay.textContent = options.defaultDivisor;
            if (els.volTotalCard) els.volTotalCard.style.display = options.volEnabled ? 'flex' : 'none';
            lastParseResult = parsed;

            // messages
            const warnings = [];
            parsed.forEach(p => {
                p.components.forEach(c => {
                if (!c.ok) warnings.push(`${safeText(p.rawLine,40)} → ${c.status}`);
                });
                if (p.components.length===0 && p.aggregated && p.aggregated.status) {
                warnings.push(`${safeText(p.rawLine,40)} → ${p.aggregated.status}`);
                }
            });
            if (els.messages) {
                if (warnings.length>0) {
                    els.messages.innerHTML = `<div class="status-warn"><strong>Notes:</strong> ${escapeHtml(warnings.slice(0,4).join(' • '))}${warnings.length>4?` <span class="muted-small">(+${warnings.length-4} more)</span>`:''}</div>`;
                } else {
                    els.messages.innerHTML = `<div class="muted-small">All lines parsed OK.</div>`;
                }
            }
            }

            /* Update quantity and recalculate CBM */
            function updateQuantity(input) {
                const lineIndex = parseInt(input.dataset.line);
                const compIndex = parseInt(input.dataset.comp);
                const newQty = parseInt(input.value) || 1;
                
                if (lastParseResult[lineIndex] && lastParseResult[lineIndex].components[compIndex]) {
                    const comp = lastParseResult[lineIndex].components[compIndex];
                    const baseCbm = comp.l_m * comp.w_m * comp.h_m;
                    const baseVol = comp.vol_kg / (comp.qty || 1);
                    
                    comp.qty = newQty;
                    comp.cbm = baseCbm * newQty;
                    comp.vol_kg = baseVol * newQty;
                    
                    // Update the display
                    const row = input.closest('tr');
                    const cbmCell = row.querySelector('.cbm-cell');
                    const volCell = row.querySelector('.vol-cell');
                    const options = readOptions();
                    
                    if (cbmCell) cbmCell.textContent = formatNum(comp.cbm, options.decimals);
                    if (volCell) volCell.textContent = formatNum(comp.vol_kg, 2);
                    
                    // Recalculate totals
                    updateTotals();
                }
            }

            /* Update total calculations */
            function updateTotals() {
                let totalCbm = 0, totalVol = 0;
                const options = readOptions();
                
                lastParseResult.forEach(lineObj => {
                    if (lineObj.components.length === 0) {
                        totalCbm += Number(lineObj.aggregated?.cbm || 0);
                        totalVol += Number(lineObj.aggregated?.vol_kg || 0);
                    } else {
                        lineObj.components.forEach(comp => {
                            totalCbm += Number(comp.cbm || 0);
                            totalVol += Number(comp.vol_kg || 0);
                        });
                    }
                });
                
                if (els.totalCbm) els.totalCbm.textContent = `${formatNum(totalCbm, options.decimals)} m³`;
                if (els.totalVol) els.totalVol.textContent = `${formatNum(totalVol, 2)} kg`;
            }

            // Make updateQuantity available globally
            window.updateQuantity = updateQuantity;

            /* Helper to escape HTML */
            function escapeHtml(s){
            if (s===null||s===undefined) return '';
            return String(s).replace(/[&<>"']/g, function(m){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
            });
            }

            /* Parse and render (main) */
            function doParse(){
            const options = readOptions();
            const text = els.cbmInput?.value || '';
            // Performance: if many lines, parse in chunks (so UI doesn't freeze)
            const linesCount = text.split(/\r?\n/).filter(Boolean).length;
            if (linesCount > CONFIG.chunkThreshold) {
                // chunked processing: simple implementation with setTimeout slices
                const rawLines = text.split(/\r?\n/);
                const chunks = [];
                let idx = 0;
                const chunkSize = 200;
                function processChunk(){
                const slice = rawLines.slice(idx, idx + chunkSize);
                slice.forEach(line => { if (line.trim()) chunks.push(parseLine(line, options)); });
                idx += chunkSize;
                if (idx < rawLines.length) {
                    // update partial UI row count
                    renderResults(chunks, options);
                    setTimeout(processChunk, 10);
                } else {
                    renderResults(chunks, options);
                }
                }
                processChunk();
            } else {
                const parsed = parseInput(text, options);
                renderResults(parsed, options);
            }
            }

            /* Attach event listeners */
            const debouncedParse = debounce(doParse, CONFIG.debounceMs);

            if (els.cbmInput) {
                els.cbmInput.addEventListener('input', debouncedParse);
                
                /* Keyboard: Ctrl+Enter parse */
                els.cbmInput.addEventListener('keydown', (ev)=>{
                    if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter'){
                        doParse();
                    }
                });
            }
            
            if (els.defaultUnit) els.defaultUnit.addEventListener('change', ()=>{debouncedParse();});
            if (els.divisor) els.divisor.addEventListener('input', () => { debouncedParse(); });
            if (els.volToggle) els.volToggle.addEventListener('change', ()=>{debouncedParse();});
            if (els.decimals) els.decimals.addEventListener('change', ()=>{debouncedParse();});

            if (els.copyCsv) {
                els.copyCsv.addEventListener('click', () => {
                if (!lastCsv) {
                    navigator.clipboard.writeText('').then(()=>{},()=>{});
                } else {
                    navigator.clipboard.writeText(lastCsv).then(()=> {
                    if (els.messages) els.messages.innerHTML = `<div class="muted-small">CSV copied to clipboard.</div>`;
                    }, ()=> {
                    if (els.messages) els.messages.innerHTML = `<div class="status-warn">Copy failed (clipboard may be blocked).</div>`;
                    });
                }
                });
            }

            if (els.clearInput) {
                els.clearInput.addEventListener('click', ()=>{
                if (els.cbmInput) els.cbmInput.value = '';
                doParse();
                });
            }

            /* initial parse with defaults */
            (function init(){
            // sync UI with CONFIG
            if (els.defaultUnit) els.defaultUnit.value = CONFIG.defaultUnit;
            if (els.divisor) els.divisor.value = CONFIG.defaultDivisor;
            if (els.decimals) els.decimals.value = CONFIG.decimals;
            if (els.volToggle) els.volToggle.checked = CONFIG.volEnabled;
            doParse();
            })();

        // --- ARITZIA Formatter Logic ---
        const aritziaInput = document.getElementById("aritziaInput");
        const aritziaOutput = document.getElementById("aritziaOutput");

        if (aritziaInput && aritziaOutput) {
            aritziaInput.addEventListener("input", () => {
                const lines = aritziaInput.value.split("\n");
                const formattedBlocks = [];

                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/\s*\t\s*/); // Split by tab, allowing for surrounding whitespace
                    if (parts.length >= 4) {
                        const [po, article, style, ...descriptionParts] = parts;
                        const description = descriptionParts.join(' '); // Re-join description if it contained tabs

                        formattedBlocks.push(
                            `${description}\n` +
                            `P.O. NO.: ${po}\n` +
                            `ARTICLE: ${article}\n` +
                            `STYLE NO.: ${style}`
                        );
                    }
                });

                // Join blocks with a double newline, then apply the final universal formatting
                aritziaOutput.value = formatText(formattedBlocks.join("\n\n"));
            });
        }

        /*****************************************************************************
         * PO Formatter implementation (unchanged)
         *****************************************************************************/
        const MIN_ANCHOR_DIGITS = 6;
        function digitsOnly(s) {
            return (s || '').replace(/\D+/g, '');
        }
        function expandSlashSubgroup(rawSubgroup) {
            const rawTokens = rawSubgroup.split('/').map(t => t.trim()).filter(t => t.length > 0);
            const tokens = rawTokens.map(t => ({ raw: t, digits: digitsOnly(t) })).filter(t => t.digits.length > 0);
            if (tokens.length === 0) return [];
            let anchor = null;
            if (tokens[0].digits.length >= MIN_ANCHOR_DIGITS) {
                anchor = tokens[0].digits;
            } else {
                const candidates = tokens.filter(t => t.digits.length >= MIN_ANCHOR_DIGITS);
                if (candidates.length > 0) {
                    candidates.sort((a,b) => b.digits.length - a.digits.length);
                    anchor = candidates[0].digits;
                } else {
                    return tokens.map(t => t.digits);
                }
            }
            const anchorLen = anchor.length;
            const expanded = tokens.map(t => {
                const tok = t.digits;
                if (tok.length >= anchorLen) {
                    return tok;
                } else {
                    const prefix = anchor.slice(0, anchorLen - tok.length);
                    return (prefix + tok);
                }
            });
            return expanded;
        }
        function processPOInput(rawText) {
            if (!rawText || typeof rawText !== 'string') return '';
            const topLevelGroups = rawText
                .split(/[\n\r,;]+/)
                .map(g => g.trim())
                .filter(g => g.length > 0);

            const collected = [];
            const seen = new Set();

            topLevelGroups.forEach(group => {
                const parts = group.split(/\s+/).map(p => p.trim()).filter(p => p.length > 0);
                parts.forEach(part => {
                    const cleanedPart = part.replace(/^[,;]+|[,;]+$/g, '');
                    if (cleanedPart.includes('/')) {
                        const expanded = expandSlashSubgroup(cleanedPart);
                        expanded.forEach(tok => {
                            const normalized = digitsOnly(tok);
                            if (!normalized) return;
                            if (!seen.has(normalized)) {
                                seen.add(normalized);
                                collected.push(normalized);
                            }
                        });
                    } else {
                        const normalized = digitsOnly(cleanedPart);
                        if (!normalized) return;
                        if (!seen.has(normalized)) {
                            seen.add(normalized);
                            collected.push(normalized);
                        }
                    }
                });
            });

            return collected.join(',');
        }

        // Hook PO processing to UI elements
        const poInput = document.getElementById('poInput');
        const poOutput = document.getElementById('poOutput');
        const poDebug = document.getElementById('poDebug');
        const runSamplesBtn = document.getElementById('runSamplesBtn');

        function processPOAndRender() {
            if (!poInput || !poOutput) return '';
            const raw = poInput.value || '';
            const out = processPOInput(raw);
            poOutput.value = out;
            return out;
        }

        if (poInput) {
            poInput.addEventListener('input', () => {
                processPOAndRender();
            });

            // OCR paste support for PO input
            poInput.addEventListener('paste', (e) => {
                const clipboard = e.clipboardData || window.clipboardData;
                const text = clipboard.getData("text/plain");
                if (text && text.trim().length > 0) {
                    setTimeout(processPOAndRender, 10);
                } else {
                    const items = clipboard.items || [];
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type && items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = items[i].getAsFile();
                            processImageFile(file);
                            break;
                        }
                    }
                }
            });

            // drop support
            poInput.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const f = e.dataTransfer.files[0];
                    if (f.type && f.type.indexOf('image') !== -1) {
                        processImageFile(f);
                    }
                }
            });
            poInput.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
        }

        if (runSamplesBtn && poDebug) {
            runSamplesBtn.addEventListener('click', () => {
                const samples = [
                    {
                        name: 'Duplicate removal',
                        input: '3810083392,3810083406,3810083392',
                        expected: '3810083392,3810083406'
                    },
                    {
                        name: 'Simple slash expansion',
                        input: '536838863/962/292',
                        expected: '536838863,536838962,536838292'
                    },
                    {
                        name: 'Long slash expansion + mix',
                        input: '810083407/392/393/400/401/406',
                        expected: '810083407,810083392,810083393,810083400,810083401,810083406'
                    }
                ];

                let debugLines = [];
                samples.forEach(s => {
                    const actual = (function(){
                        if (poInput) poInput.value = s.input;
                        return processPOAndRender();
                    })();
                    const pass = actual === s.expected;
                    debugLines.push(`Test: ${s.name}`);
                    debugLines.push(`Input: ${s.input}`);
                    debugLines.push(`Expected: ${s.expected}`);
                    debugLines.push(`Actual:   ${actual}`);
                    debugLines.push(`PASS: ${pass}`);
                    debugLines.push('-------------------------');
                });

                poDebug.textContent = debugLines.join('\n');
            });
        }

        // Add copy PO functionality for PO formatter
        const copyPOsBtn = document.getElementById('copyPOs');
        if (copyPOsBtn) {
            copyPOsBtn.addEventListener('click', () => {
                const output = poOutput?.value || '';
                if (!output) {
                    alert('No PO numbers to copy.');
                    return;
                }
                navigator.clipboard.writeText(output).then(() => {
                    copyPOsBtn.textContent = 'Copied ✓';
                    setTimeout(() => copyPOsBtn.textContent = 'Copy PO Numbers', 1200);
                }, () => alert('Copy failed.'));
            });
        }

        window.addEventListener('load', () => {
            if (poInput && poInput.value.trim().length > 0) processPOAndRender();
        });

        /****************************************************************************
         * Text-to-Columns Implementation (NEW)
         *
         * Behavior:
         * - Robust splitting: supports space, forward slash '/', and backslash '\'
         * - If a subgroup contains multiple separators (e.g. 123/ABC/XYZ) -> first token = PO, last token = Destination
         * - Removes stray punctuation, trims, uppercases Destination
         * - Outputs aligned PO and Dest columns (newline-separated) so copy/paste to Excel works naturally
         ****************************************************************************/

        const ttcInput = document.getElementById('ttcInput');
        const ttcPOs = document.getElementById('ttcPOs');
        const ttcDests = document.getElementById('ttcDests');
        const ttcInvalid = document.getElementById('ttcInvalid');
        const ttcSummary = document.getElementById('ttcSummary');
        const processTTCBtn = document.getElementById('processTTCBtn');
        const clearTTCInput = document.getElementById('clearTTCInput');
        const copyTTCPOsBtn = document.getElementById('copyPOs');
        const copyTTCCSVBtn = document.getElementById('copyCSV');

        function safeTrim(s) { return (s || '').trim(); }

        // Updated splitter: splits on whitespace OR forward slash OR backslash
        // If multiple tokens, use first as PO and last as Destination (per request)
        function splitLineToPOAndDest(line) {
            // Normalize whitespace sequences to single space, trim
            const normalized = line.replace(/\t+/g, ' ').replace(/ {2,}/g, ' ').trim();
            if (!normalized) return null;

            // Split on /, \, or whitespace sequences
            const tokens = normalized.split(/[\/\\\s]+/).map(t => t.trim()).filter(t => t.length > 0);
            if (tokens.length === 0) return null;

            // First token => PO, Last token => Destination
            const rawPo = tokens[0];
            const rawDest = tokens.length >= 2 ? tokens[tokens.length - 1] : '';

            // Clean tokens: remove surrounding non-alphanumeric (keep digits & letters & hyphen)
            const po = (rawPo || '').replace(/[^A-Za-z0-9-]/g, '');
            const dest = (rawDest || '').replace(/[^A-Za-z0-9-]/g, '').toUpperCase();

            return { po: po, dest: dest };
        }

        function isBlankLine(line) {
            return !line || line.trim().length === 0;
        }

        function processTextToColumns() {
            if (!ttcInput || !ttcPOs || !ttcDests || !ttcSummary) return { poList: [], destList: [], invalidLines: [] };
            
            const raw = ttcInput.value || '';
            // Keep original line ordering but ignore fully blank lines
            const lines = raw.split(/\r?\n/);
            const poList = [];
            const destList = [];
            const invalidLines = [];

            lines.forEach((ln, idx) => {
                if (isBlankLine(ln)) return; // ignore blank
                const parsed = splitLineToPOAndDest(ln);
                if (!parsed) return;
                // If PO is empty after parsing, consider invalid/skipped
                if (!parsed.po || parsed.po.length === 0) {
                    invalidLines.push(`Line ${idx+1}: "${ln}" => missing PO`);
                    return;
                }
                poList.push(parsed.po);
                if (!parsed.dest || parsed.dest.length === 0) {
                    destList.push(''); // keep alignment with blank dest
                    invalidLines.push(`Line ${idx+1}: "${ln}" => missing destination`);
                } else {
                    destList.push(parsed.dest);
                }
            });

            // Populate outputs
            ttcPOs.value = poList.join('\n');
            ttcDests.value = destList.join('\n');

            // Show invalid box if any invalid lines
            if (ttcInvalid) {
                if (invalidLines.length > 0) {
                    ttcInvalid.style.display = 'block';
                    ttcInvalid.textContent = 'Lines with missing data:\n' + invalidLines.join('\n');
                } else {
                    ttcInvalid.style.display = 'none';
                    ttcInvalid.textContent = '';
                }
            }

            ttcSummary.textContent = `${poList.length} lines processed${invalidLines.length ? ' • ' + invalidLines.length + ' issue(s)' : ''}`;
            return { poList, destList, invalidLines };
        }

        // Wire UI events
        if (processTTCBtn) {
            processTTCBtn.addEventListener('click', () => {
                processTextToColumns();
            });
        }

        // Also process live on paste / input for convenience
        if (ttcInput) {
            ttcInput.addEventListener('input', () => {
                processTextToColumns();
            });
        }

        if (clearTTCInput) {
            clearTTCInput.addEventListener('click', () => {
                if (ttcInput) ttcInput.value = '';
                if (ttcPOs) ttcPOs.value = '';
                if (ttcDests) ttcDests.value = '';
                if (ttcInvalid) {
                    ttcInvalid.style.display = 'none';
                    ttcInvalid.textContent = '';
                }
                if (ttcSummary) ttcSummary.textContent = '0 lines processed';
            });
        }

        // Copy helper that writes to clipboard and returns a promise
        function copyToClipboard(text) {
            if (!navigator.clipboard) {
                // fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    return Promise.resolve();
                } catch (e) {
                    document.body.removeChild(ta);
                    return Promise.reject(e);
                }
            }
            return navigator.clipboard.writeText(text);
        }

        if (copyTTCPOsBtn) {
            copyTTCPOsBtn.addEventListener('click', () => {
                // Ensure latest processing
                const { poList } = processTextToColumns();
                if (!poList || poList.length === 0) {
                    copyToClipboard('').then(() => alert('No PO values to copy.'), () => alert('Copy failed.'));
                    return;
                }
                const text = poList.join('\n'); // newline-separated -> vertical cells in Excel
                copyToClipboard(text).then(() => {
                    // small visual feedback (non-blocking)
                    copyTTCPOsBtn.textContent = 'Copied ✓';
                    setTimeout(() => copyTTCPOsBtn.textContent = 'Copy PO', 1200);
                }, () => alert('Copy failed.'));
            });
        }

        if (copyTTCCSVBtn) {
            copyTTCCSVBtn.addEventListener('click', () => {
                const { poList, destList } = processTextToColumns();
                if (!poList || poList.length === 0) {
                    copyToClipboard('').then(() => alert('No data to copy as CSV.'), () => alert('Copy failed.'));
                    return;
                }
                // Build CSV rows, escaping if needed
                const rows = [];
                for (let i = 0; i < poList.length; i++) {
                    const p = poList[i] || '';
                    const d = (destList && destList[i]) ? destList[i] : '';
                    // simple quoting if contains comma or quotes or newline
                    const q = v => {
                        if (v === null || v === undefined) return '';
                        const s = String(v);
                        if (s.includes('"')) {
                            return '"' + s.replace(/"/g, '""') + '"';
                        }
                        if (s.includes(',') || s.includes('\n')) {
                            return '"' + s + '"';
                        }
                        return s;
                    };
                    rows.push(q(p) + ',' + q(d));
                }
                const csvText = rows.join('\n');
                copyToClipboard(csvText).then(() => {
                    copyTTCCSVBtn.textContent = 'Copied ✓';
                    setTimeout(() => copyTTCCSVBtn.textContent = 'Copy as CSV', 1200);
                }, () => alert('Copy failed.'));
            });
        }

        // Allow dropping an image onto the TTC input to OCR and process (reuses processImageFile)
        if (ttcInput) {
            ttcInput.addEventListener('paste', (e) => {
                const clipboard = e.clipboardData || window.clipboardData;
                const text = clipboard.getData("text/plain");
                if (text && text.trim().length > 0) {
                    setTimeout(processTextToColumns, 10);
                } else {
                    const items = clipboard.items || [];
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type && items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = items[i].getAsFile();
                            processImageFile(file);
                            break;
                        }
                    }
                }
            });

            ttcInput.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const f = e.dataTransfer.files[0];
                    if (f.type && f.type.indexOf('image') !== -1) {
                        processImageFile(f);
                    }
                }
            });
            ttcInput.addEventListener('dragover', (e) => e.preventDefault());
        }

        // Initialize TTC summary on load
        window.addEventListener('load', () => {
            if (ttcSummary) ttcSummary.textContent = '0 lines processed';
        });

        // Simple page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Add active to corresponding nav link
            const navLinks = document.querySelectorAll('.nav-link');
            if (pageId === 'home' && navLinks[0]) navLinks[0].classList.add('active');
            if (pageId === 'store' && navLinks[1]) navLinks[1].classList.add('active');
            if (pageId === 'workspace' && navLinks[2]) navLinks[2].classList.add('active');
        }

        // Initialize workspace tab functionality
        window.addEventListener('load', () => {
            if (window.location.hash === '#workspace') showPage('workspace');
        });

        // Tool management functions
        function addToolToWorkspace(toolId) {
            // Find first empty slot
            const emptySlot = document.querySelector('.workspace-tab.empty');
            if (!emptySlot) {
                alert('All workspace slots are full. Remove a tool first.');
                return;
            }

            const slotIndex = parseInt(emptySlot.dataset.slot);
            
            // Update tab
            emptySlot.classList.remove('empty');
            emptySlot.innerHTML = `
                <span>${getToolName(toolId)}</span>
                <div class="tab-controls">
                    <button class="tab-control-btn" onclick="removeToolFromSlot(${slotIndex})" title="Remove">×</button>
                </div>
            `;
            emptySlot.dataset.toolId = toolId;

            // Switch to this tab and show the tool
            switchWorkspaceTab(slotIndex);
            showPage('workspace');
        }

        function getToolName(toolId) {
            const names = {
                'text-formatter': 'Text Formatter',
                'cbm-calculator': 'CBM Calculator',
                'aritzia-formatter': 'ARITZIA Formatter',
                'po-formatter': 'PO Formatter',
                'text-to-columns': 'Text-to-Columns'
            };
            return names[toolId] || toolId;
        }

        // Workspace tab switching
        function switchWorkspaceTab(slotIndex) {
            // Remove active from all tabs and content
            document.querySelectorAll('.workspace-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tool-workspace').forEach(workspace => workspace.classList.remove('active'));

            // Activate selected tab
            const selectedTab = document.querySelector(`[data-slot="${slotIndex}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Show corresponding workspace
                const toolId = selectedTab.dataset.toolId;
                if (toolId) {
                    const workspace = document.getElementById(`${toolId}-workspace`);
                    if (workspace) {
                        workspace.classList.add('active');
                    }
                } else {
                    // Show empty workspace
                    document.getElementById('empty-workspace').classList.add('active');
                }
            }
        }

        // Remove tool from workspace
        function removeToolFromSlot(slotIndex) {
            const slot = document.querySelector(`[data-slot="${slotIndex}"]`);
            if (slot) {
                slot.classList.add('empty');
                slot.innerHTML = '<span>+ Add Tool</span>';
                slot.removeAttribute('data-tool-id');
                
                // If this was the active tab, switch to empty workspace
                if (slot.classList.contains('active')) {
                    document.querySelectorAll('.tool-workspace').forEach(workspace => workspace.classList.remove('active'));
                    document.getElementById('empty-workspace').classList.add('active');
                }
            }
        }

        // Search functionality
        function filterTools() {
            const searchTerm = document.getElementById('toolSearch').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            document.querySelectorAll('.tool-card').forEach(card => {
                const toolName = card.querySelector('.tool-name').textContent.toLowerCase();
                const toolDescription = card.querySelector('.tool-description').textContent.toLowerCase();
                const categories = card.dataset.categories || '';
                const tags = card.dataset.tags || '';
                
                const matchesSearch = !searchTerm || 
                    toolName.includes(searchTerm) || 
                    toolDescription.includes(searchTerm) ||
                    tags.includes(searchTerm);
                
                const matchesCategory = !selectedCategory || categories.includes(selectedCategory);
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Load more tools (placeholder)
        function loadMoreTools() {
            // Placeholder for loading more tools
            console.log('Loading more tools...');
        }

        // Make functions globally available
        window.showPage = showPage;
        window.addToolToWorkspace = addToolToWorkspace;
        window.switchWorkspaceTab = switchWorkspaceTab;
        window.removeToolFromSlot = removeToolFromSlot;
        window.filterTools = filterTools;
        window.loadMoreTools = loadMoreTools;
    </script>
</body>
</html>
